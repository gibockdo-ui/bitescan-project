<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUSIMUSI 프로토타입</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto+Sans+KR', sans-serif;
        }
        .step { display: none; }
        .step.active { display: block; }
        .symptom-btn.selected {
            background-color: #eef0ff;
            border-color: #4154FF;
            color: #4154FF;
        }
        .accordion-content { display: none; }
        .accordion-header.active + .accordion-content { display: block; }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-md bg-white rounded-2xl shadow-lg overflow-hidden">
        <!-- Header -->
        <div class="header bg-[#4154FF] text-white p-5 text-center">
            <h1 class="text-2xl font-bold">MUSIMUSI</h1>
        </div>
        
        <div class="content p-6 md:p-8">

            <!-- Step 1: Home -->
            <div id="step1" class="step active">
                <h2 class="text-xl font-bold text-slate-800 mb-3">여행 중 벌레에 물리셨나요?</h2>
                <p class="text-slate-600 mb-6">사진 한 장으로 지금 바로 확인하고 대처하세요. AI 분석, 응급처치, 약국 가이드부터 호텔 룸 변경 요청까지 도와드립니다.</p>
                <button class="w-full bg-[#4154FF] text-white font-bold py-3 px-4 rounded-lg transition-all hover:brightness-95" onclick="showStep(2)">지금 바로 분석 시작하기</button>
            </div>

            <!-- Step 2: Upload -->
            <div id="step2" class="step">
                <h2 class="text-xl font-bold text-slate-800 mb-3">Step 1. 사진 업로드</h2>
                <p class="text-slate-600 mb-6">상처 부위나 발견한 벌레 사진을 올려주세요.</p>
                
                <input type="file" id="imageUpload" accept="image/*" capture="environment" class="hidden">
                <label for="imageUpload" class="w-full text-center block bg-[#4154FF] text-white font-bold py-3 px-4 rounded-lg transition-all hover:brightness-95 cursor-pointer">
                    카메라 촬영 / 앨범에서 선택
                </label>

                <div class="mt-4 border border-dashed border-slate-300 rounded-lg p-4 min-h-[200px] flex justify-center items-center">
                    <img id="imagePreview" class="hidden max-w-full max-h-48 rounded-md" src="#" alt="Image preview" />
                    <span id="previewText" class="text-slate-400">사진을 등록해주세요.</span>
                </div>
                
                <button id="nextToSymptomsBtn" class="w-full bg-slate-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-600 transition-colors mt-4 hidden" onclick="showStep(3)">다음 단계로</button>
            </div>

            <!-- Step 3: Symptoms -->
            <div id="step3" class="step">
                <h2 class="text-xl font-bold text-slate-800 mb-3">Step 2. 증상 선택</h2>
                <p class="text-slate-600 mb-6">현재 느끼는 증상을 모두 선택해주세요.</p>
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="symptom-btn border border-slate-300 rounded-lg p-3 text-center cursor-pointer" onclick="toggleSymptom(this)">가려움</div>
                    <div class="symptom-btn border border-slate-300 rounded-lg p-3 text-center cursor-pointer" onclick="toggleSymptom(this)">통증</div>
                    <div class="symptom-btn border border-slate-300 rounded-lg p-3 text-center cursor-pointer" onclick="toggleSymptom(this)">붓기</div>
                    <div class="symptom-btn border border-slate-300 rounded-lg p-3 text-center cursor-pointer" onclick="toggleSymptom(this)">물집</div>
                    <div class="symptom-btn border border-slate-300 rounded-lg p-3 text-center cursor-pointer" onclick="toggleSymptom(this)">열감</div>
                    <div class="symptom-btn border border-slate-300 rounded-lg p-3 text-center cursor-pointer" onclick="toggleSymptom(this)">없음</div>
                </div>
                <button class="w-full bg-[#4154FF] text-white font-bold py-3 px-4 rounded-lg transition-all hover:brightness-95" onclick="startAnalysis()">분석 결과 보기</button>
            </div>
            
            <!-- Step 4: Loading -->
            <div id="step4" class="step">
                <div class="text-center py-10">
                    <div class="spinner w-12 h-12 border-4 border-slate-200 border-t-[#4154FF] rounded-full mx-auto mb-4"></div>
                    <p class="text-slate-600">AI가 상처와 증상을<br>분석하고 있습니다...</p>
                </div>
            </div>

            <!-- Step 5: Results -->
            <div id="step5" class="step">
                <h2 class="text-xl font-bold text-slate-800 mb-4">AI 종합 분석 결과</h2>
                <div id="result-summary" class="mb-4"></div>
                <div class="space-y-3">
                    <!-- Accordion Items -->
                     <div class="accordion-item border border-slate-200 rounded-lg">
                        <div class="accordion-header p-4 cursor-pointer font-semibold flex justify-between items-center" onclick="toggleAccordion(this)">
                            <span>응급처치 가이드</span><span class="transform transition-transform duration-300">▼</span>
                        </div>
                        <div class="accordion-content p-4 border-t border-slate-200 text-slate-600">
                            <p>1. 흐르는 깨끗한 물과 비누로 상처 부위를 씻어주세요.</p>
                            <p>2. 깨끗한 수건으로 감싼 얼음으로 10분간 냉찜질을 하세요.</p>
                            <p>3. 가렵더라도 절대 긁지 마세요. 2차 감염의 원인이 됩니다.</p>
                        </div>
                    </div>
                    <div class="accordion-item border border-slate-200 rounded-lg">
                        <div class="accordion-header p-4 cursor-pointer font-semibold flex justify-between items-center" onclick="toggleAccordion(this)">
                            <span>호텔 대처 가이드</span><span class="transform transition-transform duration-300">▼</span>
                        </div>
                        <div class="accordion-content p-4 border-t border-slate-200 text-slate-600">
                            <h4 class="font-bold mb-2">상황 설명 및 방역 요청</h4>
                            <pre id="script1" class="bg-slate-100 p-3 rounded-md text-sm whitespace-pre-wrap">Hello, I believe I was bitten by a bug in my room (Room #____). Could you please send someone to inspect and disinfect the room immediately?</pre>
                            <button class="bg-green-600 text-white text-xs font-bold py-1 px-3 rounded-md mt-2 hover:bg-green-700" onclick="copyScript('script1')">스크립트 복사</button>
                            <h4 class="font-bold mt-4 mb-2">룸 변경 요청</h4>
                            <pre id="script2" class="bg-slate-100 p-3 rounded-md text-sm whitespace-pre-wrap">I was bitten by a bug in my room and I have a photo of the bite. For my safety and hygiene, I would like to request a room change immediately. Could you please arrange a new room for me?</pre>
                            <button class="bg-green-600 text-white text-xs font-bold py-1 px-3 rounded-md mt-2 hover:bg-green-700" onclick="copyScript('script2')">스크립트 복사</button>
                        </div>
                    </div>
                    <div class="accordion-item border border-slate-200 rounded-lg">
                        <div class="accordion-header p-4 cursor-pointer font-semibold flex justify-between items-center" onclick="toggleAccordion(this)">
                            <span>약국/병원 방문 가이드</span><span class="transform transition-transform duration-300">▼</span>
                        </div>
                        <div class="accordion-content p-4 border-t border-slate-200 text-slate-600">
                             <p><b>- 연고:</b> <span class="text-[#4154FF] font-mono">Hydrocortisone 1% cream</span></p>
                             <p><b>- 알레르기 약:</b> <span class="text-[#4154FF] font-mono">Loratadine or Cetirizine</span></p>
                             <div class="mt-6 pt-4 border-t border-slate-200">
                                <h4 class="font-bold mb-2">내 주변 의료시설 찾기</h4>
                                <div class="flex space-x-3">
                                    <a href="https://www.google.com/maps/search/?api=1&query=pharmacy+near+me" target="_blank" class="flex-1 text-center bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600 no-underline">주변 약국 찾기 🏥</a>
                                    <a href="https://www.google.com/maps/search/?api=1&query=hospital+near+me" target="_blank" class="flex-1 text-center bg-rose-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-rose-600 no-underline">주변 병원 찾기 🚑</a>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>
                 <button class="w-full bg-slate-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-600 mt-6" onclick="showStep(1)">처음으로 돌아가기</button>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        const steps = document.querySelectorAll('.step');

        function showStep(stepNumber) {
            steps.forEach(step => step.classList.remove('active'));
            document.getElementById(`step${stepNumber}`).classList.add('active');
            currentStep = stepNumber;
        }

        const imageUpload = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imagePreview');
        const previewText = document.getElementById('previewText');
        const nextToSymptomsBtn = document.getElementById('nextToSymptomsBtn');

        imageUpload.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                    previewText.classList.add('hidden');
                    nextToSymptomsBtn.classList.remove('hidden');
                }
                reader.readAsDataURL(file);
            }
        });

        function toggleSymptom(element) {
            element.classList.toggle('selected');
        }

        function startAnalysis() {
            showStep(4);
            const imageData = imagePreview.src;
            
            // 시뮬레이션 함수 대신 실제 Roboflow API 호출 함수로 변경
            callRoboflowApi(imageData)
                .then(apiResult => {
                    generateResultsFromApi(apiResult);
                })
                .catch(error => {
                    console.error("API Error:", error);
                    // 에러 발생 시 사용자에게 알림
                    const errorResult = {
                        riskClass: 'bg-gray-200 border-gray-500 text-gray-800',
                        riskText: '분석 실패',
                        insect: '알 수 없음',
                        summary: 'AI 분석 중 오류가 발생했습니다. 네트워크 연결을 확인하거나 다른 사진으로 다시 시도해주세요.'
                    };
                    generateResults(errorResult);
                });
        }

        // --- Roboflow API 호출을 위한 실제 함수 ---
        async function callRoboflowApi(imageData) {
            // 🚨 중요: 이 API 키는 Roboflow에서 발급받은 본인의 키로 교체해야 합니다.
            // 🚨 보안 경고: 이 키를 HTML에 직접 노출하는 것은 매우 위험합니다.
            // 실제 서비스에서는 서버를 통해 안전하게 호출해야 합니다.
            const API_KEY = "YOUR_ROBOFLOW_API_KEY"; // ⬅️ 여기에 자신의 Roboflow API 키를 입력하세요.
            const MODEL_ENDPOINT = "insect-bites/1"; // Roboflow 모델 정보

            // Base64 데이터에서 순수한 이미지 데이터 부분만 추출
            const base64Image = imageData.split(',')[1];

            console.log("Roboflow API로 실제 분석을 요청합니다...");

            const response = await fetch(
                `https://detect.roboflow.com/${MODEL_ENDPOINT}?api_key=${API_KEY}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: base64Image
                }
            );
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            console.log("API 분석 결과:", result);
            return result;
        }

        // --- API 결과를 바탕으로 사용자에게 보여줄 내용을 가공하는 함수 ---
        function generateResultsFromApi(apiResult) {
            // API가 분석 결과를 주지 않았거나, 아무것도 찾지 못한 경우
            if (!apiResult || !apiResult.predictions || apiResult.predictions.length === 0) {
                const noResult = {
                    riskClass: 'bg-gray-200 border-gray-500 text-gray-800',
                    riskText: '판독 불가',
                    insect: '알 수 없음',
                    summary: '사진에서 벌레나 상처를 인식하지 못했습니다. 더 선명하거나 다른 각도의 사진으로 다시 시도해주세요.'
                };
                generateResults(noResult);
                return;
            }

            // 가장 확률이 높은 예측 결과 하나를 사용
            const prediction = apiResult.predictions[0];
            const insectClass = prediction.class; // 예: "Bed-Bug", "Mosquito-bite"

            // API 결과(영어)를 사용자 친화적인 한국어 정보로 변환
            const resultMapping = {
                'Bed-Bug': { riskClass: 'bg-yellow-100 border-yellow-500 text-yellow-800', riskText: '주의: 증상 관찰 및 대처 필요', insect: '빈대 (Bed Bug)', summary: '심각한 질병을 옮기진 않지만, 심한 가려움증과 알레르기 반응을 유발할 수 있습니다. 추가 피해 방지를 위해 호텔 측에 즉시 알리고 룸 변경을 요청하세요.'},
                'Mosquito-bite': { riskClass: 'bg-green-100 border-green-500 text-green-800', riskText: '안전: 자가 처치 가능', insect: '모기 (Mosquito)', summary: '일반적인 모기 물림으로 보입니다. 가렵더라도 긁지 말고, 냉찜질이나 약국 연고를 사용하세요.'},
                // 여기에 Roboflow 모델이 인식하는 다른 벌레 종류들을 추가할 수 있습니다.
                'default': { riskClass: 'bg-red-100 border-red-500 text-red-800', riskText: '위험: 가까운 병원 방문 권장', insect: `알 수 없는 벌레 (${insectClass})`, summary: '알려지지 않은 벌레이거나 독성이 의심됩니다. 정확한 진단을 위해 가까운 병원을 방문하는 것을 권장합니다.'}
            };

            const finalResult = resultMapping[insectClass] || resultMapping['default'];
            generateResults(finalResult);
        }

        // --- 최종 결과를 화면에 그려주는 함수 ---
        function generateResults(result) {
            const resultSummary = document.getElementById('result-summary');
            resultSummary.innerHTML = `
                <div class="result-card border-l-4 p-4 rounded-r-lg ${result.riskClass}">
                    <h3 class="font-bold mb-1">${result.riskText}</h3>
                    <p class="text-sm"><strong>AI 추정 벌레: ${result.insect}</strong></p>
                </div>
                <p class="text-slate-600 mt-4">${result.summary}</p>
                <p class="text-xs text-slate-400 mt-4">※ 이 분석은 의학적 진단이 아니며, 응급처치 및 대처를 돕기 위한 AI 추정치입니다.</p>
            `;
            showStep(5);
        }

        function toggleAccordion(header) {
            header.classList.toggle('active');
            const icon = header.querySelector('span:last-child');
            icon.classList.toggle('rotate-180');
        }

        function copyScript(scriptId) {
            const textToCopy = document.getElementById(scriptId).innerText;
            const textArea = document.createElement('textarea');
            textArea.value = textToCopy;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                alert('스크립트가 복사되었습니다!');
            } catch (err) { console.error('Fallback: Oops, unable to copy', err); }
            document.body.removeChild(textArea);
        }
        
        showStep(1);
    </script>
</body>
</html>
